<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Exfil — Media Metadata Remover</title>
  <style>
    body { font-family: system-ui, -apple-system, Segoe UI, Roboto, Ubuntu, Cantarell, 'Helvetica Neue', Arial, sans-serif; margin: 0; background: #0b0f14; color: #e6edf3; }
    header { padding: 16px 20px; background: #0f1720; border-bottom: 1px solid #1f2a36; display: flex; gap: 16px; align-items: center; }
    .brand { font-weight: 700; letter-spacing: 0.3px; }
    main { max-width: 980px; margin: 24px auto; padding: 0 16px 48px; }
    .panel { background: #0f1720; border: 1px solid #1f2a36; border-radius: 10px; padding: 16px; margin-bottom: 16px; }
    .row { display: flex; gap: 12px; flex-wrap: wrap; align-items: center; }
    .col { flex: 1; min-width: 260px; }
    select, input[type="text"], button { background: #0b0f14; color: #e6edf3; border: 1px solid #243141; border-radius: 8px; padding: 10px 12px; }
    button { cursor: pointer; }
    button.primary { background: #1f6feb; border-color: #1f6feb; }
    button:disabled { opacity: 0.6; cursor: not-allowed; }
    .drop { border: 2px dashed #243141; border-radius: 12px; padding: 28px; text-align: center; color: #9fb3c8; }
    .drop.drag { border-color: #1f6feb; background: #0b1625; color: #cfe3ff; }
    .files { margin-top: 10px; font-size: 14px; color: #9fb3c8; }
    .mono { font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", "Courier New", monospace; }
    .muted { color: #9fb3c8; }
    .ok { color: #59d185; }
    .error { color: #ff6b6b; }
    details { background: #0b0f14; border: 1px solid #243141; border-radius: 8px; padding: 10px 12px; }
    summary { cursor: pointer; }
    .hr { height: 1px; background: #1f2a36; margin: 16px 0; }
    .grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(260px, 1fr)); gap: 12px; }
    .chip { padding: 8px 10px; background: #0b0f14; border: 1px solid #243141; border-radius: 6px; font-size: 12px; }
    .small { font-size: 12px; }
    .cta { display: flex; gap: 10px; flex-wrap: wrap; align-items: center; }
    .code { white-space: pre-wrap; word-break: break-word; background: #0b0f14; border: 1px solid #243141; border-radius: 8px; padding: 10px; }
  </style>
</head>
<body>
  <header>
    <div class="brand">Exfil</div>
    <div class="muted small">Media metadata remover • Pay in NCH</div>
  </header>
  <main>
    <section class="panel">
      <div class="row">
        <div class="col">
          <label>Plan</label><br />
          <select id="plan">
            <option value="Free">Free</option>
            <option value="Starter">Starter</option>
            <option value="Pro">Pro</option>
          </select>
          <div class="small muted" id="plan-note">Free: 10 images/day, ≤15MB each. No IPFS.</div>
        </div>
        <div class="col">
          <label>API Key (optional)</label><br />
          <input id="apiKey" type="text" placeholder="x-api-key for paid API usage" />
        </div>
      </div>
      <div class="hr"></div>
      <div class="row">
        <div class="col">
          <div id="drop" class="drop">
            <div><strong>Drag & drop</strong> files here or</div>
            <div style="margin-top:6px"><input id="picker" type="file" multiple /></div>
            <div class="small muted" style="margin-top:8px">Images, audio, video, PDFs, ZIPs (per plan limits)</div>
          </div>
          <div id="files" class="files"></div>
        </div>
      </div>
      <div class="hr"></div>
      <div class="cta">
        <button id="clean" class="primary">Clean metadata</button>
        <label class="small"><input id="useIpfs" type="checkbox" /> Upload to IPFS (Pro)</label>
        <span id="status" class="small muted"></span>
      </div>
    </section>

    <section class="panel">
      <h3>Payments</h3>
      <div class="grid">
        <div class="chip">
          <div class="small muted">NCH receive address</div>
          <div id="addr" class="mono"></div>
        </div>
        <div class="chip">
          <div class="small muted">Verify payment (txid)</div>
          <div class="row">
            <input id="txid" type="text" class="col" placeholder="Paste txid" />
            <button id="verify">Verify</button>
          </div>
          <div id="verifyStatus" class="small muted"></div>
        </div>
      </div>
      <div class="small muted" style="margin-top:8px">Fiber chain: final settlement on first seen tx.</div>
    </section>

    <section class="panel">
      <details>
        <summary>Pricing</summary>
        <div class="small">
          Free: 10 images/day, ≤15MB each. No API. No IPFS.<br/>
          Starter $7/mo (1,000 incl., $0.008 over), ≤250MB. UI+API.<br/>
          Pro $19/mo (10,000 incl., $0.006 over), ≤1GB, batch ZIP. UI+API. IPFS upload/pinning via https://ipfs.ness.cx/ipfs up to 50GB/mo.<br/>
          Business/Enterprise available on request.
        </div>
      </details>
    </section>

    <section class="panel" id="output" style="display:none">
      <h3>Results</h3>
      <div id="results"></div>
    </section>
  </main>

<script>
(function(){
  const planEl = document.getElementById('plan');
  const apiKeyEl = document.getElementById('apiKey');
  const drop = document.getElementById('drop');
  const picker = document.getElementById('picker');
  const filesBox = document.getElementById('files');
  const cleanBtn = document.getElementById('clean');
  const statusEl = document.getElementById('status');
  const useIpfsEl = document.getElementById('useIpfs');
  const outPanel = document.getElementById('output');
  const resultsEl = document.getElementById('results');
  const addrEl = document.getElementById('addr');
  const txidEl = document.getElementById('txid');
  const verifyBtn = document.getElementById('verify');
  const verifyStatus = document.getElementById('verifyStatus');

  // Load payment address
  fetch('/api/payments/address').then(r=>r.json()).then(j=>{
    addrEl.textContent = j.address || '';
  }).catch(()=>{});

  function setStatus(t, cls){ statusEl.className = 'small ' + (cls||'muted'); statusEl.textContent = t; }

  // drag & drop
  let queue = [];
  function showQueue(){
    filesBox.textContent = queue.length ? `${queue.length} file(s) ready` : '';
  }
  ['dragenter','dragover'].forEach(ev=>drop.addEventListener(ev, e=>{ e.preventDefault(); drop.classList.add('drag'); }));
  ;['dragleave','drop'].forEach(ev=>drop.addEventListener(ev, e=>{ e.preventDefault(); drop.classList.remove('drag'); }));
  drop.addEventListener('drop', (e)=>{
    const items = e.dataTransfer.files;
    for (const f of items) queue.push(f);
    showQueue();
  });
  picker.addEventListener('change', ()=>{ for (const f of picker.files) queue.push(f); showQueue(); });

  planEl.addEventListener('change', ()=>{
    const v = planEl.value;
    const note = document.getElementById('plan-note');
    if (v === 'Free') note.textContent = 'Free: 10 images/day, ≤15MB each. No IPFS.';
    else if (v === 'Starter') note.textContent = 'Starter: All formats ≤250MB. UI + API.';
    else note.textContent = 'Pro: All formats ≤1GB. Batch ZIP. IPFS upload/pinning included.';
  });

  async function b64FromBlob(blob){
    const arr = await blob.arrayBuffer();
    const b = new Uint8Array(arr);
    let bin = ''; for (let i=0;i<b.length;i++) bin += String.fromCharCode(b[i]);
    return btoa(bin);
  }

  async function clean(){
    if (!queue.length) { setStatus('No files selected','error'); return; }
    setStatus('Uploading…');
    const form = new FormData();
    queue.forEach(f=>form.append('files', f, f.name));
    const headers = { 'x-plan': planEl.value };
    if (apiKeyEl.value) headers['x-api-key'] = apiKeyEl.value;

    const r = await fetch('/api/clean', { method:'POST', body: form, headers });
    const j = await r.json();
    if (!r.ok || !j.ok) { setStatus(j.error || 'Failed','error'); return; }

    outPanel.style.display = '';
    resultsEl.innerHTML = '';
    for (const item of j.results){
      const url = `data:${(item.mimeType||'application/octet-stream')};base64,${item.dataBase64}`;
      const a = document.createElement('a');
      a.href = url; a.download = item.filename; a.textContent = `Download ${item.filename}`; a.className='small';

      const pre = document.createElement('div');
      pre.className = 'code small';
      pre.textContent = `before: ${item.beforeHash}\nafter:  ${item.afterHash}`;

      const wrap = document.createElement('div');
      wrap.className = 'panel';
      wrap.appendChild(a);
      wrap.appendChild(pre);

      // Optional IPFS upload for Pro
      if (useIpfsEl.checked && planEl.value === 'Pro'){
        const ipfsBtn = document.createElement('button');
        ipfsBtn.textContent = 'Upload to IPFS';
        ipfsBtn.onclick = async ()=>{
          ipfsBtn.disabled = true; ipfsBtn.textContent = 'Uploading…';
          const hdr = { 'content-type':'application/json', 'x-plan':'Pro' };
          if (apiKeyEl.value) hdr['x-api-key'] = apiKeyEl.value;
          const res = await fetch('/api/ipfs/add', { method:'POST', headers: hdr, body: JSON.stringify({ filename: item.filename, dataBase64: item.dataBase64 }) });
          const ij = await res.json();
          if (!res.ok || !ij.ok){ ipfsBtn.textContent = 'IPFS failed'; ipfsBtn.className='error'; return; }
          ipfsBtn.textContent = 'Uploaded'; ipfsBtn.className='ok';
          const out = document.createElement('div'); out.className='small mono';
          out.textContent = JSON.stringify(ij.ipfs);
          wrap.appendChild(out);
        };
        wrap.appendChild(ipfsBtn);
      }

      resultsEl.appendChild(wrap);
    }
    setStatus('Done','ok');
  }

  cleanBtn.addEventListener('click', clean);

  verifyBtn.addEventListener('click', async ()=>{
    const txid = txidEl.value.trim();
    if (!txid) { verifyStatus.textContent = 'Enter a txid'; return; }
    verifyStatus.textContent = 'Verifying…';
    const r = await fetch('/api/payments/verify', { method:'POST', headers:{'content-type':'application/json'}, body: JSON.stringify({ txid }) });
    const j = await r.json();
    if (!r.ok) { verifyStatus.textContent = j.error || 'Verification failed'; verifyStatus.className='error small'; return; }
    if (j.ok){ verifyStatus.textContent = 'Payment received.'; verifyStatus.className='ok small'; }
    else { verifyStatus.textContent = 'No matching payment to our address.'; verifyStatus.className='error small'; }
  });
})();
</script>
</body>
</html>
